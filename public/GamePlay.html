<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../public/style.css">
    <style>
        .game-timer {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: #ffd700;
            padding: 10px 30px;
            border-radius: 20px;
            font-size: 32px;
            font-weight: bold;
            z-index: 1000;
            font-family: monospace;
        }

        .player-list {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.4);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 18px;
            line-height: 1.8;
            min-width: 150px;
        }

        .player-list b {
            color: #ffd700;
        }

        .countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 120px;
            font-weight: bold;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .game-over-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 3000;
            font-family: Arial, sans-serif;
        }

        .game-over-title {
            font-size: 48px;
            font-weight: bold;
            margin-bottom: 30px;
            color: #ffd700;
        }

        .scoreboard {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            min-width: 400px;
        }

        .score-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            font-size: 24px;
        }

        .medal {
            font-size: 32px;
            margin-right: 15px;
        }

        .gold { color: #ffd700; }
        .silver { color: #c0c0c0; }
        .bronze { color: #cd7f32; }

        .player-name {
            flex: 1;
            text-align: left;
        }

        .player-score {
            font-weight: bold;
            color: #ffd700;
        }
    </style>
</head>

<body class="gamePlay-page">
    <div class="game-timer" id="gameTimer">00:00</div>
    <div class="player-list" id="playerList">Loading...</div>
    <input type="text" class="InputWord" placeholder="Input word">
    <div id="stage"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const stage = document.getElementById("stage");
        const input = document.querySelector(".InputWord");
        const gameTimer = document.getElementById("gameTimer");
        const playerList = document.getElementById("playerList");
        let myName = localStorage.getItem("playerName") || "Unknown";
        const duration = parseInt(localStorage.getItem("gameDuration") || "1") * 60;
        let remaining = duration;
        let gameEnded = false;
        socket.on("connect", () => {
            setTimeout(() => {
                socket.emit("registerPlayerName", myName);
                console.log("Sent real name:", myName);
            }, 500);
        });
        socket.on("nameUpdated", (name) => {
            myName = name;
            console.log("Server confirmed name:", name);
        });

        function startCountdownAndTimer() {
            const overlay = document.createElement("div");
            overlay.className = "countdown-overlay";
            overlay.textContent = "3";
            document.body.appendChild(overlay);
            let count = 3;
            const interval = setInterval(() => {
                count--;
                if (count > 0) overlay.textContent = count;
                else if (count === 0) overlay.textContent = "START!";
                else {
                    clearInterval(interval);
                    overlay.style.opacity = "0";
                    setTimeout(() => overlay.remove(), 500);
                    updateTimer();
                }
            }, 1000);
        }

        function updateTimer() {
            const m = String(Math.floor(remaining / 60)).padStart(2, "0");
            const s = String(remaining % 60).padStart(2, "0");
            gameTimer.textContent = `${m}:${s}`;
            if (remaining > 0) {
                remaining--;
                setTimeout(updateTimer, 1000);
            } else {
                gameTimer.textContent = "TIME UP!";
                gameEnded = true;
                socket.emit("gameEnded");
            }
        }

        function showGameOverScreen(finalScores) {
            const overlay = document.createElement("div");
            overlay.className = "game-over-overlay";
            
            const title = document.createElement("div");
            title.className = "game-over-title";
            title.textContent = "‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß!";
            
            const scoreboard = document.createElement("div");
            scoreboard.className = "scoreboard";
            
            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
            const sortedScores = finalScores.sort((a, b) => b.score - a.score);
            
            sortedScores.forEach((player, index) => {
                const scoreItem = document.createElement("div");
                scoreItem.className = "score-item";
                
                const medal = document.createElement("span");
                medal.className = "medal";
                
                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ï‡∏≤‡∏°‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö
                if (index === 0) {
                    medal.textContent = "ü•á";
                    medal.classList.add("gold");
                } else if (index === 1) {
                    medal.textContent = "ü•à";
                    medal.classList.add("silver");
                } else if (index === 2) {
                    medal.textContent = "ü•â";
                    medal.classList.add("bronze");
                } else {
                    medal.textContent = "üèÖ";
                }
                
                const playerName = document.createElement("span");
                playerName.className = "player-name";
                playerName.textContent = player.name;
                
                const playerScore = document.createElement("span");
                playerScore.className = "player-score";
                playerScore.textContent = player.score;
                
                scoreItem.appendChild(medal);
                scoreItem.appendChild(playerName);
                scoreItem.appendChild(playerScore);
                scoreboard.appendChild(scoreItem);
            });
            
            overlay.appendChild(title);
            overlay.appendChild(scoreboard);
            document.body.appendChild(overlay);
        }
        startCountdownAndTimer();

        socket.on("spawnAnimal", (batch) => {
            // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏¥‡∏î‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Å‡∏°‡∏à‡∏ö‡πÅ‡∏•‡πâ‡∏ß
            if (gameEnded) return;
            
            batch.forEach((data) => {
                const wrap = document.createElement("div");
                wrap.classList.add("animal-wrapper");
                wrap.dataset.word = data.word.toLowerCase();
                wrap.style.top = `${data.y}px`;
                const animal = document.createElement("div");
                animal.classList.add("animal", data.type);
                const label = document.createElement("div");
                label.classList.add("word-label", "float-text");
                label.textContent = data.word;
                wrap.append(label, animal);
                stage.appendChild(wrap);
                let x = data.goRight ? -80 : window.innerWidth + 80;
                const sp = data.goRight ? 0.6 : -0.6;
                wrap.style.left = `${x}px`;
                animal.style.animation = `walk 0.8s steps(4) infinite`;
                if (!data.goRight) animal.style.transform = "scaleX(-1)";
                const move = () => {
                    x += sp;
                    wrap.style.left = `${x}px`;
                    if ((data.goRight && x > window.innerWidth + 100) || (!data.goRight && x < -100)) wrap.remove();
                    else requestAnimationFrame(move);
                };
                requestAnimationFrame(move);
            });
        });

        input.addEventListener("keydown", (e) => {
            if (e.key === "Enter" && !gameEnded) {
                const t = input.value.trim().toLowerCase();
                if (!t) return;
                socket.emit("removeAnimal", t);
                input.value = "";
            }
        });

        socket.on("removeAnimal", (word) => {
            document.querySelectorAll(".animal-wrapper").forEach((w) => {
                if ((w.dataset.word || "").toLowerCase() === word) {
                    w.style.transition = "opacity 0.4s ease-out";
                    w.style.opacity = "0";
                    setTimeout(() => w.remove(), 400);
                }
            });
        });

        socket.on("updateScores", (scoreList) => {
            playerList.innerHTML = scoreList
                .map((s) => `${s.name === myName ? "‚≠ê " : ""}${s.name}: <b>${s.score}</b>`)
                .join("<br>");
        });

        socket.on("updatePlayers", (players) => {
            playerList.innerHTML = players
                .map((p) => `${p.name}: <b>0</b>`)
                .join("<br>");
        });

        socket.on("gameOver", (finalScores) => {
            showGameOverScreen(finalScores);
        });
    </script>



</body>

</html>